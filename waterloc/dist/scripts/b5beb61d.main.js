"use strict";function handle(){var a=this.id.substr(1,this.id.length),b=document.getElementById("_"+this.id);this.checked?(b.style.backgroundColor="#bff0a1",uwaterloo.getBuilding(a,singleModel)):(b.style.backgroundColor="#ADD1FF",singleModel.remove(a)),listModel.changeList(a,this.checked)}var deleteFlag=!1,globalCode="",ModelModule=function(){var a=function(){this.listeners=[]};_.extend(a.prototype,{addListener:function(a){this.listeners.push(a)},removeListener:function(a){var b=this.listeners.indexOf(a);-1!==b&&this.listeners.splice(b,1)},notify:function(){for(var a=0;a<this.listeners.length;a++)this.listeners[a].update()}});var b=function(b,c,d,e,f){a.apply(this,arguments),this.name=b,this.id=c,this.code=d,this.lat=e,this.lng=f};_.extend(b.prototype,a.prototype,{filter:function(a,b){var c=this;null!==a?(console.log(a),alert(a)):(c.name=b.building_name,c.code=b.building_code,c.id=b.building_id,c.lat=b.latitude,c.lng=b.longitude,c.notify())},remove:function(a){deleteFlag=!0,globalCode=a,this.notify(),deleteFlag=!1,globalCode=""}});var c=function(){a.apply(this,arguments),this.listArr=[],this.searchArr=[]};return _.extend(c.prototype,a.prototype,{filter:function(a,b,c){var d=this,e=d.listArr.length;if(d.listArr.splice(0,e),null!==a)console.log(a),alert(a);else for(var f=0;f<b.length;f++){var g=b[f].building_code,h=b[f].building_name;if(null!==g.match(c)||null!==h.match(c)){var i={data:b[f],checked:!1};d.listArr.push(i)}}d.notify()},findBuilding:function(a){var b=this,c=b.searchArr.length;b.searchArr.splice(0,c);for(var d=0;d<b.listArr.length;d++){var e=b.listArr[d].data.building_code,f=b.listArr[d].data.building_name;if(null!==e.match(a)||null!==f.match(a)){var g={data:b.listArr[d].data,checked:b.listArr[d].checked};b.searchArr.push(g)}}b.notify()},changeList:function(a,b){for(var c=this,d=c.listArr.length,e=0;d>e;e++)a===c.listArr[e].data.building_code&&(c.listArr[e].checked=b)}}),{BuildingModel:b,BuildingListModel:c}}(),ServiceModule=function(){var a=function(){this.key="da2a56dc8d6aadb150bf77d9e2e2d937",this.urlPrefix="https://api.uwaterloo.ca/v2"};return _.extend(a.prototype,{queryBuildings:function(a,b){var c=this,d=c.urlPrefix+"/buildings/list.json?key="+c.key;$.ajax({type:"GET",url:d,dataType:"json"}).done(function(c){200===c.meta.status?b.filter(null,c.data,a):b.filter("Building not found",null,a)}).fail(function(){var c="AJAX call failed: ";b.filter(c,null,a)})},getBuilding:function(a,b){var c=this,d=c.urlPrefix+"/buildings/"+a+".json?key="+c.key;$.ajax({type:"GET",url:d,dataType:"json"}).done(function(a){200===a.meta.status?b.filter(null,a.data):b.filter("Building not found",null)}).fail(function(){var a="AJAX call failed: ";b.filter(a,null)})}}),{UWaterlooService:a}}(),map,search=!1,ViewModule=function(){var a=function(a){this.model=a,this.model.addListener(this)};_.extend(a.prototype,{init:function(){map=new google.maps.Map(document.getElementById("map_canvas"),{center:new google.maps.LatLng(43.472761,-80.542164),zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP})},update:function(){deleteFlag?this.deleteMarker(globalCode):this.viewUpdate()}});var b=function(b,c){a.apply(this,arguments),this.UWaterlooService=c};_.extend(b.prototype,a.prototype,{viewUpdate:function(){var a=document.getElementById("scrolBox");if(a.innerHTML="",search)for(var b=0;null!==this.model.searchArr[b];b++){var c=this.model.searchArr[b].data.building_name+" ("+this.model.searchArr[b].data.building_code+")",d=document.createElement("INPUT"),e=document.createTextNode(c),f=document.createElement("LABEL");d.id="_"+this.model.searchArr[b].data.building_code,d.setAttribute("class","inputBox"),d.name="_"+this.model.searchArr[b].data.building_code,d.type="checkbox",d.addEventListener("change",handle),f.className="checkbox-inline control-label",f.id="_"+d.id,this.model.searchArr[b].checked&&(d.checked=!0,f.style.backgroundColor="#bff0a1"),f.appendChild(d),f.appendChild(e),a.appendChild(f),a.appendChild(document.createElement("BR"))}else for(var g=0;null!==this.model.listArr[g];g++){var h=this.model.listArr[g].data.building_name+" ("+this.model.listArr[g].data.building_code+")",i=document.createElement("INPUT"),j=document.createTextNode(h),k=document.createElement("LABEL");i.id="_"+this.model.listArr[g].data.building_code,i.setAttribute("class","inputBox"),i.name="_"+this.model.listArr[g].data.building_code,i.type="checkbox",i.addEventListener("change",handle),k.className="checkbox-inline control-label ",k.id="_"+i.id,k.appendChild(i),k.appendChild(j),a.appendChild(k),a.appendChild(document.createElement("BR"))}}});var c=function(b,c){a.apply(this,arguments),this.UWaterlooService=c,this.usedMarkers=[],google.maps.event.addDomListener(window,"load",this.init)};return _.extend(c.prototype,a.prototype,{viewUpdate:function(){var a=this,b=new google.maps.LatLng(a.model.lat,a.model.lng),c=new google.maps.Marker({position:b,map:map,animation:google.maps.Animation.DROP,title:a.model.code});setTimeout(function(){c.setAnimation(google.maps.Animation.BOUNCE)},600),setTimeout(function(){c.setAnimation(null)},2e3);var d={code:a.model.code,marker:c};a.usedMarkers.push(d)},deleteMarker:function(a){for(var b=this,c=0;c<b.usedMarkers.length;)b.usedMarkers[c].code!==a?c++:(b.usedMarkers[c].marker.setMap(null),b.usedMarkers.splice(c,1))}}),{BuildingListView:b,MapView:c}}(),uwaterloo,singleModel,listModel;!function(a,b,c){$(document).ready(function(){listModel=new a.BuildingListModel,singleModel=new a.BuildingModel,uwaterloo=new c.UWaterlooService,new b.BuildingListView(listModel,uwaterloo),new b.MapView(singleModel,uwaterloo);var d=!1;$("#searchInput").focus(function(){d||(d=!0,search=!1,uwaterloo.queryBuildings(".*",listModel))}),$("#searchInput").keyup(function(a){search=!0;for(var b=".*",c=0;c<this.value.length;c++)" "!=this.value.charAt(c)&&(b+=this.value.charAt(c),b+=".*");listModel.findBuilding(b+".*")})})}(ModelModule,ViewModule,ServiceModule);